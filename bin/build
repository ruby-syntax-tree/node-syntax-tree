#!/usr/bin/env node

const { execSync } = require("child_process");
const esbuild = require("esbuild");
const path = require("path");

const wasmPlugin = {
  name: "wasm",
  setup(build) {
    let path = require("path")
    let fs = require("fs")

    build.onLoad({ filter: /\.wasm$/ }, async (args) => ({
      contents: await fs.promises.readFile(args.path),
      loader: "binary"
    }));

    // When we're done building the output, we'll want to additionally build the
    // typescript declarations file.
    build.onEnd((result) => {
      if (result.errors.length === 0) {
        execSync("./node_modules/.bin/tsc");
      }
    });
  }
};

esbuild.build({
  bundle: true,
  entryPoints: [path.join(__dirname, "../src/index.ts")],
  format: "cjs",
  minify: true,
  outdir: path.join(__dirname, "../dist"),
  platform: "node",
  plugins: [wasmPlugin],
  sourcemap: false,
  target: "es6"
});
